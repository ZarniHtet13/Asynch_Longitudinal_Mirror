---
title: "Loess Smoothing"
author: "Zarni Htet"
output: "github_document"
---

### Libraries
```{r, R.options= "true"}
require (rio) # For importing data set
require (mi)  # For removing missing data
require (dplyr) # For grouping manipulations
```

### Importing Data
```{r}
#interpolated data
bmi_media <- import("../../data/final/final_interp_data.csv")
bmi_media <- bmi_media[,-1]
print(sum(is.na(bmi_media)))
print(dim(bmi_media))
```

```{r}
#raw data
bmi_media_raw <- import("../../data/final/final_na_data.csv")
bmi_media_raw <- bmi_media_raw[,-1]
print(dim(bmi_media_raw))
print(dim(bmi_media_raw[complete.cases(bmi_media_raw),]))
```


### Check the Distribution of Media Exposure

* Question: If we are checking the distribution of media exposure, should not we be checking the distribution of other variables too? *

```{r}
par(mfrow=c(1,1))
plot(density(bmi_media$Media), main = "Density of Media Exposure")
```
As expected, there are a lot of zeros. What does zero Media Exposure *could* mean? It could mean that some of the subjects (kids) actually are not exposed to media at all. It could also mean that there are some self-reported errors in the data collection.

Transforming Media Exposure to adjust for the zeros 
```{r}
media_trans <- bmi_media$Media
media_trans_1 <- sqrt(media_trans)
media_trans_2 <- log(media_trans + 1)
media_trans_3 <- log(media_trans + 0.1) #Daphna's suggestion
media_trans_4 <- log(media_trans + 0.5) #Marc's suggestion
```

```{r}
par(mfrow= c(2,2))
plot(density(media_trans_1), main = "Sqrt Density of Media Exposure")
plot(density(media_trans_2), main = "Log_1 Density of Media Exposure")
plot(density(media_trans_3), main = "Log_0.1 Density of Media Exposure")
plot(density(media_trans_4), main = "Log_0.5 Density of Media Exposure")
```






### Trajectory for Linearly Interpolated Data Set

#### 1: LOESS application of 1 month interval at each time cut point

The goal here is to bin media usage to 5 categories (0 hrs, 1 hrs, 2 hrs, 3 hrs and 4 hrs) starting from a baseline of 6 months. Then, we will follow the trajectory for these *same* subjectIDs for 13.5 months, 21 months, 28.5 months and 36 months.


We are subsetting the data set to only include the SubjectIDs that have media exposure at about 1 month interval
centering at 6 months.

```{r}
#The base data set for all the Ids for this Lowess Curve
base <- bmi_media[bmi_media$Months >=5.5 & bmi_media$Months <= 6.5,]
sum(is.na(base))
#The distribution of the cut off points for media usage
print(quantile(base$Media))
```

```{r}
#The distribution of cut off points for time for the same Subject IDs
base_alltime <- bmi_media[bmi_media$ID %in% base$ID,]
print(sum(is.na(base_alltime)))
#Quantile breaks for Media Exposure
print(table(cut(base_alltime$Media, breaks = quantile(base_alltime$Media))))
#the Cut command returns a vector where each entry has a factor indicator of what quantile it belongs to 
#datasub <- cut(base_alltime$Media, breaks = quantile(base_alltime$Media), include.lowest = TRUE)
```

Binning the months by interval of a month to desired integers of 6, 13.5, 21, 28.5, 36

```{r}
base_alltime[base_alltime$Months >=5.5 & base_alltime$Months <= 6.5,]$Months <-6
base_alltime[base_alltime$Months >=13 & base_alltime$Months <= 14,]$Months <-13.5
base_alltime[base_alltime$Months >=20.5 & base_alltime$Months <= 21.5,]$Months <-21
base_alltime[base_alltime$Months >=28 & base_alltime$Months <= 29,]$Months <-28.5
base_alltime[base_alltime$Months >=35.5 & base_alltime$Months <= 36.5,]$Months <-36
```

Subsetting the data set of those months only

```{r}
x <- c(6, 13.5, 21, 28.5, 36) # Months Vector for subsetting data
base_alltime <- base_alltime[base_alltime$Months %in% x,]
```

Divide the IDs into 4 categories based on the media usage quantiles above starting at a baseline of 6 months

```{r}
#6 months base IDs
base_6 <- base_alltime[base_alltime$Months %in% c(6),]
base6_l1 <- base_6[base_6$Media >=0 & base_6$Media <4.11, ]
base6_l2 <- base_6[base_6$Media >=4.11 & base_6$Media <4.76, ]
base6_l3 <- base_6[base_6$Media >=4.76 & base_6$Media <5.2, ]
base6_l4 <- base_6[base_6$Media >=5.2 & base_6$Media <6.7, ]
```

```{r, warning=FALSE}
#Getting the same baseline level IDs for Trajectories across the months
base_l1 <- base_alltime[base_alltime$ID %in% base6_l1$ID,]
base_l2 <- base_alltime[base_alltime$ID %in% base6_l2$ID,]
base_l3 <- base_alltime[base_alltime$ID %in% base6_l3$ID,]
base_l4 <- base_alltime[base_alltime$ID %in% base6_l4$ID,]

#print(base_l1)

x<- c(6, 13.5, 21, 28.5, 36)
y<- c(-4.86, -0.39, 0.40, 1.18, 4.98)

plot(x, y, type = "n", main = "4 Bucket BMI Trajectory with Interpolated Data", ylim = c(0,2))
lines(loess.smooth(x = base_l1$Months, y = base_l1$zBMI), col = "green")
lines(loess.smooth(x = base_l2$Months, y = base_l2$zBMI), col = "yellow")
lines(loess.smooth(x = base_l3$Months, y = base_l3$zBMI), col = "orange")
lines(loess.smooth(x = base_l4$Months, y = base_l4$zBMI), col = "blue")
legend("topleft", legend = c("0-hrs", "1-hrs", "2-hrs", "3-hrs"), col = c("green", "yellow", "red","blue"), lty = 1, cex = 0.8)
```



### Trajectory for Raw Data

#### Steps to apply data trajectory

```{r}
head(bmi_media_raw)
```

Initial Data Explorations

```{r}
#Number of unique subjectIDs
print(length(unique(bmi_media_raw$ID))) #537
```

```{r}
#Checking out the distribution of Months
plot(density(bmi_media_raw$Months), main = "Months Distribution", xlim = c(4,8))
hist(bmi_media_raw$Months, xlim = c(2,20))
```

Binning the Baseline 6 months

Due to the histogram distribution being flat between 5-10 months, I would wager to bin 6 months by a 1 month range of between 5 and 7.

```{r}
baseline <- bmi_media_raw
#creating baseline 6 months interval
baseline[baseline$Months >=5 & baseline$Months <= 7,]$Months <- 6
```

Pulling the 6 months data set out to **categorize** the subjectIDs by their Media Exposure quantiles.

```{r}
baseline_6months <- baseline[baseline$Months == 6, ]
#Number of unique subjectIDs at baseline 6 months
print(length(unique(baseline_6months$ID))) #460
#Out of 537 subjectIDs at all time, we lose around 77 subject IDs.
print(537-460) 
```

For each subjectID, how many has 1 instance of non-NA media exposure value at 6 months?

```{r}
baseline_6_media_nonNA <- baseline_6months %>% group_by(ID) %>% summarise(non_na_count = sum(!is.na(Media)))
print(dim(baseline_6_media_nonNA)) #460 subjectIDs
head(baseline_6_media_nonNA)
```

Out of the 460 subjectIDs, how many has the non-NA values for Media exposure at 6 months? <br />
What percentage of the subjectIDs does it correspond to?

```{r}
print(sum(baseline_6_media_nonNA$non_na_count)) #289
#Proportionally, it corresponds to 
print((289/460) * 100)
```

Check the distribution of BMI values at baseline 6 months

```{r}
plot(hist(baseline_6months$Media, na.rm = TRUE), main = "Media Distribution at 6 months")
```

Use cut to divide into 0,1,2,3, and above 4 to reflect the 

```{r}
labels <- c("0hrs", "1hrs", "2hrs", "3hrs", "4hrs")
breaks <- c(0,1,2,3,4,6.3) #The breaks are based on slide 38 of Langone Hospital presentation with the maximum BMI hours being the end point.
cut(baseline_6months$Media, breaks = breaks, include.lowest = TRUE, right = FALSE)
```

- Figure out how to apply cut's result back to the data set (Is it match?)
- Subset these IDs back from the Raw Data
- Apply the Categories to this raw data set
- Need to create intervals for the rest of the months based on what you had for 6 months (a 2 months interval)








#### 1: LOESS application of across all time periods with base at 6 months

```{r}
#The base data set for all the Ids for this Lowess Curve
base_6_raw <- bmi_media_raw_nna[bmi_media_raw_nna$Months >=5.5 & bmi_media_raw_nna$Months <= 6.5,]
#The distribution of the cut off points for media usage
print(quantile(base_6_raw$Media))
```

```{r}
#The distribution of cut off points for time for the same Subject IDs
base_alltime_raw <- bmi_media_raw_nna[bmi_media_raw_nna$ID %in% base_6_raw$ID,]
print(sum(is.na(base_alltime_raw)))
#Quantile breaks for Media Exposure
table(cut(base_alltime_raw$Media, breaks = quantile(base_alltime_raw$Media)))
#the Cut command returns a vector where each entry has a factor indicator of what quantile it belongs to 
#datasub <- cut(base_alltime$Media, breaks = quantile(base_alltime$Media), include.lowest = TRUE)
```

```{r}
#Getting the Loess data points
base6_l1_raw <- base_6_raw[base_6_raw$Media >=0 & base_6_raw$Media <4.11, ]
base6_l2_raw <- base_6_raw[base_6_raw$Media >=4.11 & base_6_raw$Media <4.79, ]
base6_l3_raw <- base_6_raw[base_6_raw$Media >=4.79 & base_6_raw$Media <5.30, ]
base6_l4_raw <- base_6_raw[base_6_raw$Media >=5.30 & base_6_raw$Media <6.24, ]
```

```{r}
#Getting the same baseline level IDs for Trajectories across the months
base_l1_raw <- base_alltime_raw[base_alltime_raw$ID %in% base6_l1_raw$ID,] #everything is at 6 months
base_l2_raw <- base_alltime_raw[base_alltime_raw$ID %in% base6_l2_raw$ID,]
base_l3_raw <- base_alltime_raw[base_alltime_raw$ID %in% base6_l3_raw$ID,]
base_l4_raw <- base_alltime_raw[base_alltime_raw$ID %in% base6_l4_raw$ID,]
```


```{r, warning=FALSE}
x<- c(6, 13.5, 21, 28.5, 36)
y<- c(-4.86, -0.39, 0.40, 1.18, 4.98)

plot(x, y, type = "n", main = "4 Bucket BMI Trajectory with Raw Data", ylim = c(-10,10))
lines(loess.smooth(x = base_l1_raw$Months, y = base_l1_raw$zBMI), col = "green")
lines(loess.smooth(x = base_l2_raw$Months, y = base_l2_raw$zBMI), col = "yellow")
lines(loess.smooth(x = base_l3_raw$Months, y = base_l3_raw$zBMI), col = "orange")
lines(loess.smooth(x = base_l4_raw$Months, y = base_l4_raw$zBMI), col = "blue")
legend("topleft", legend = c("0-hrs", "1-hrs", "2-hrs", "3-hrs"), col = c("green", "yellow", "red","blue"), lty = 1, cex = 0.8)
```

### Diagonosis

```{r}

min(base_l2_raw$zBMI)
max(base_l1_raw$zBMI)
base_l3_raw$zBMI

```


<!-- ## IGNORE CODE BELOW -->

<!-- #### 2: LOESS application of 1 month interval at each time cut point with base at 6 months -->

<!-- The goal here is to bin media usage to 5 categories (0 hrs, 1 hrs, 2 hrs, 3 hrs and 4 hrs) starting from a baseline of 6 months. Then, we will follow the same trajectory for these *same* subjectIDs for 13.5 months, 21 months, 28.5 months and 36 months. -->

<!-- **The Time Conversion** -->

<!-- #### Question to Marc -->

<!-- *Do you want me to exponetiate? It would blow up the current range of Hrs we have from 0-7. -->
<!-- The Log would bring in negative values.* -->
<!-- ```{r} -->


<!-- ``` -->


<!-- We are subsetting the data set to only include the SubjectIDs that have media exposure at about 1 month interval -->
<!-- centering at 6 months. -->

<!-- ```{r} -->
<!-- #The base data set for all the Ids for this Lowess Curve -->
<!-- base_raw <- bmi_media_raw_nna[bmi_media_raw_nna$Months >=5.5 & bmi_media_raw_nna$Months <= 6.5,] -->
<!-- #The distribution of the cut off points for media usage -->
<!-- print(quantile(base_raw$Media)) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- #The distribution of cut off points for time for the same Subject IDs -->
<!-- base_alltime_raw <- bmi_media_raw_nna[bmi_media_raw_nna$ID %in% base_raw$ID,] -->
<!-- print(sum(is.na(base_alltime_raw))) -->
<!-- #Quantile breaks for Media Exposure -->
<!-- table(cut(base_alltime_raw$Media, breaks = quantile(base_alltime_raw$Media))) -->
<!-- #the Cut command returns a vector where each entry has a factor indicator of what quantile it belongs to  -->
<!-- #datasub <- cut(base_alltime$Media, breaks = quantile(base_alltime$Media), include.lowest = TRUE) -->
<!-- ``` -->

<!-- Binning the months by interval of a month to desired integers of 6, 13.5, 21, 28.5, 36 -->

<!-- ```{r} -->
<!-- base_alltime_raw[base_alltime_raw$Months >=5.5 & base_alltime_raw$Months <= 6.5,]$Months <-6 -->
<!-- base_alltime_raw[base_alltime_raw$Months >=13 & base_alltime_raw$Months <= 14,]$Months <-13.5 -->
<!-- #Data interval has to be widened for the month centered around 21 to 3 month interval -->
<!-- base_alltime_raw[base_alltime_raw$Months >=18.5 & base_alltime_raw$Months <= 23.5,]$Months <-21 -->
<!-- base_alltime_raw[base_alltime_raw$Months >=28 & base_alltime_raw$Months <= 29,]$Months <-28.5 -->
<!-- base_alltime_raw[base_alltime_raw$Months >=35.5 & base_alltime_raw$Months <= 36.5,]$Months <-36 -->
<!-- ``` -->

<!-- Subsetting the data set of those months only -->

<!-- ```{r} -->
<!-- x <- c(6, 13.5, 21, 28.5, 36) # Months Vector for subsetting data -->
<!-- base_alltime_raw <- base_alltime_raw[base_alltime_raw$Months %in% x,] -->
<!-- ``` -->

<!-- Divide the IDs into 4 categories based on Media usage quantile above starting at base like of 6 months. -->
<!-- The quantile cuts in raw data are **different** from the quantile cuts of interpolated data which is to be expected.  -->

<!-- ```{r} -->
<!-- #6 months base IDs -->
<!-- base_6_raw <- base_alltime_raw[base_alltime_raw$Months %in% c(6),] -->
<!-- base6_l1_raw <- base_6_raw[base_6_raw$Media >=0 & base_6_raw$Media <4.11, ] -->
<!-- base6_l2_raw <- base_6_raw[base_6_raw$Media >=4.11 & base_6_raw$Media <4.8, ] -->
<!-- base6_l3_raw <- base_6_raw[base_6_raw$Media >=4.8 & base_6_raw$Media <5.28, ] -->
<!-- base6_l4_raw <- base_6_raw[base_6_raw$Media >=5.28 & base_6_raw$Media <6.24, ] -->
<!-- ``` -->

<!-- ```{r} -->
<!-- #Getting the same baseline level IDs for Trajectories across the months -->
<!-- base_l1_raw <- base_alltime_raw[base_alltime_raw$ID %in% base6_l1_raw$ID,] -->
<!-- base_l2_raw <- base_alltime_raw[base_alltime_raw$ID %in% base6_l2_raw$ID,] -->
<!-- base_l3_raw <- base_alltime_raw[base_alltime_raw$ID %in% base6_l3_raw$ID,] -->
<!-- base_l4_raw <- base_alltime_raw[base_alltime_raw$ID %in% base6_l4_raw$ID,] -->

<!-- x<- c(6, 13.5, 21, 28.5, 36) -->
<!-- y<- c(-4.86, -0.39, 0.40, 1.18, 4.98) -->

<!-- plot(x, y, type = "n", main = "4 Bucket BMI Trajectory with Raw Data", ylim = c(-1.0,10.0)) -->
<!-- lines(loess.smooth(x = base_l1_raw$Months, y = base_l1_raw$zBMI), col = "green") -->
<!-- lines(loess.smooth(x = base_l2_raw$Months, y = base_l2_raw$zBMI), col = "yellow") -->
<!-- lines(loess.smooth(x = base_l3_raw$Months, y = base_l3_raw$zBMI), col = "orange") -->
<!-- lines(loess.smooth(x = base_l4_raw$Months, y = base_l4_raw$zBMI), col = "blue") -->
<!-- legend("topleft", legend = c("0-hrs", "1-hrs", "2-hrs", "3-hrs"), col = c("green", "yellow", "red","blue"), lty = 1, cex = 0.8) -->
<!-- ``` -->




